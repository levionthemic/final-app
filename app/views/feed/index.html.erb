<div class="feeds" >
  <div class="feeds-wrap">
    <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
      <input type="radio" class="btn-check" name="typepage" id="photo" autocomplete="off" <%= 'checked' if @tab == 'photos' %> />
      <%= label_tag "photo", "PHOTO", class: "btn btn-outline-primary tab-label", data: { url: root_path(tab: "photos") } %>
      <input type="radio" class="btn-check" name="typepage" id="album" autocomplete="off" <%='checked' if @tab == 'albums' %>/>
      <%= label_tag "album", "ALBUM", class: "btn btn-outline-primary tab-label", data: { url: root_path(tab: "albums") } %>
    </div>
    <div class="feeds-list">
      <% @items.each do |item| %>
        <div class="feeds-list__item">
          <div class="feeds-list__item--image" data-bs-toggle="modal" data-bs-target="#viewFeed" data-title="<%= item.title %>" data-description="<%= item.description %>" data-image="<%= url_for(item.image) if !params[:tab] || params[:tab] == 'photos' %>" data-images='<%= raw(item.photos.map(&:image).to_json) if params[:tab] == 'albums' %>'>
            <% if !params[:tab] || params[:tab] == 'photos' %>
              <%= image_tag "#{item.image}", alt: "" %>
            <% else %>
              <div class="p-3 w-100 h-100 d-flex align-items-center justify-content-center">
                <%= image_tag "#{item.photos[0].image}", alt: "" %>
                <%= image_tag "#{item.photos[0].image}", alt: "" %>
                <%= image_tag "#{item.photos[0].image}", alt: "" %>
              </div>
            <% end  %>
          </div>
          <div class="feeds-list__item--content">
            <div class="">
              <%= link_to user_path(item.user), class: "feeds-list__item--profile" do %>
                <div class="feeds-list__item--avatar">
                  <%= image_tag "#{item.user.avatar}", alt: "Avatar", class: "" %>
                </div>
                <span><%= "#{item.user.first_name} #{item.user.last_name}" %></span>
              <% end %>
              <p class="my-2"><b><%= item.title %></b></p>
              <p class="feeds-list__item--desc">
                <%= item.description %>
              </p>
            </div>
            <div class="feeds-list__item--time">
              <div class="d-flex align-items-center gap-1" style="cursor: pointer">
                <i class="fa-solid fa-heart heart-icon"></i>
                <span>123</span>
              </div>
              <p><%= item.created_at.strftime("%-I:%M %P %d/%m/%Y") %></p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <nav aria-label="...">
      <ul class="pagination">
        <li class="page-item"><a href="#" class="page-link">Previous</a></li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item active">
          <a class="page-link" href="#" aria-current="page">2</a>
        </li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item"><a class="page-link" href="#">Next</a></li>
      </ul>
    </nav>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="viewFeed" tabindex="-1" aria-labelledby="viewFeedLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="viewFeedLabel">
        </h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <% if !params[:tab] || params[:tab] == 'photos' %>
          <img src="" alt="" id="modal-photo-image" class="w-100 h-auto mb-3">
        <% else %>
          <div id="carouselExample" class="carousel slide mb-3" style="display: none;">
            <div class="carousel-inner"></div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        <% end %>
        <div id="modal-photo-description"></div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener("turbo:load", () => {
    // Tab label
    document.querySelectorAll(".tab-label").forEach(label => {
      label.addEventListener("click", e => {
        e.preventDefault()
        const url = e.currentTarget.dataset.url;
        if (url) Turbo.visit(url);
      });
    });

    const modal = document.getElementById("viewFeed");
    const titleEl = modal.querySelector(".modal-title");
    const descEl = modal.querySelector("#modal-photo-description");
    const imageEl = modal.querySelector("#modal-photo-image");

    const carouselEl = modal.querySelector("#carouselExample");
    const carouselInner = carouselEl?.querySelector(".carousel-inner");

    document.querySelectorAll(".feeds-list__item--image").forEach(item => {
      item.addEventListener("click", () => {
        // Reset
        document.querySelectorAll(".modal-backdrop").forEach((el, index) => {
          if (index > 0) el.remove();
        });

        const title = item.dataset.title;
        const description = item.dataset.description;
        const imageArray = item.dataset.images ? JSON.parse(item.dataset.images) : null;

        titleEl.textContent = title;
        descEl.textContent = description;

        if (imageArray && imageArray.length > 0) {
          // Ẩn single image
          carouselEl.style.display = "block";

          // Xoá cũ
          carouselInner.innerHTML = "";

          imageArray.forEach((url, index) => {
            const div = document.createElement("div");
            div.className = "carousel-item" + (index === 0 ? " active" : "");
            div.innerHTML = `<img src="${url}" class="d-block w-100" alt="carousel image">`;
            carouselInner.appendChild(div);
          });

        } else {
          // Single image
          imageEl.src = item.dataset.image;
          imageEl.style.display = "block";
          descEl.style.display = "block";
          carouselEl.style.display = "none";
        }
      });
    });
  });
</script>
